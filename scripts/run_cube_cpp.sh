#!/usr/bin/env bash
# =============================================================================
# Cube v2 C++ Testbench Runner
# =============================================================================
# 运行 Cube v2 矩阵乘法加速器的 C++ 测试
#
# 用法:
#   scripts/run_cube_cpp.sh [options]
#
# 选项:
#   --trace    启用执行跟踪 (PYC_TRACE=1)
#   --vcd      生成 VCD 波形文件 (PYC_VCD=1)
#   --help     显示帮助信息
#
# 环境变量:
#   PYC_TRACE      设为 1 启用跟踪日志
#   PYC_VCD        设为 1 生成 VCD 波形
#   PYC_TRACE_DIR  跟踪文件输出目录
#   CXX            C++ 编译器 (默认: clang++)
#
# 示例:
#   scripts/run_cube_cpp.sh                    # 运行基本测试
#   scripts/run_cube_cpp.sh --trace --vcd     # 带跟踪和波形
#   PYC_TRACE=1 scripts/run_cube_cpp.sh       # 通过环境变量启用跟踪
# =============================================================================
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd -- "${SCRIPT_DIR}/.." && pwd)"

# shellcheck source=lib.sh
source "${ROOT_DIR}/scripts/lib.sh"

# -----------------------------------------------------------------------------
# 参数解析
# -----------------------------------------------------------------------------
show_help() {
  head -n 30 "$0" | tail -n +2 | sed 's/^# //' | sed 's/^#//'
  exit 0
}

for arg in "$@"; do
  case "${arg}" in
    --trace)
      export PYC_TRACE=1
      ;;
    --vcd)
      export PYC_VCD=1
      ;;
    --help|-h)
      show_help
      ;;
  esac
done

# -----------------------------------------------------------------------------
# 查找 pyc-compile
# -----------------------------------------------------------------------------
pyc_find_pyc_compile

# -----------------------------------------------------------------------------
# 路径配置
# -----------------------------------------------------------------------------
GEN_DIR="${ROOT_DIR}/janus/generated/janus_cube_pyc"
HDR="${GEN_DIR}/janus_cube_pyc_gen.hpp"
TB_SRC="${ROOT_DIR}/janus/tb/tb_janus_cube_pyc.cpp"

# -----------------------------------------------------------------------------
# 检查并生成头文件
# -----------------------------------------------------------------------------
if [[ ! -f "${HDR}" ]]; then
  pyc_log "生成 Cube v2 C++ 头文件..."
  bash "${ROOT_DIR}/janus/update_generated.sh"
fi

# -----------------------------------------------------------------------------
# 创建临时工作目录
# -----------------------------------------------------------------------------
WORK_DIR="$(mktemp -d -t cube_cpp_tb.XXXXXX)"
trap 'rm -rf "${WORK_DIR}"' EXIT

# -----------------------------------------------------------------------------
# 编译测试程序
# -----------------------------------------------------------------------------
pyc_log "编译 Cube v2 测试程序..."
"${CXX:-clang++}" -std=c++17 -O2 \
  -I "${ROOT_DIR}/include" \
  -I "${GEN_DIR}" \
  -o "${WORK_DIR}/tb_cube" \
  "${TB_SRC}"

# -----------------------------------------------------------------------------
# 运行测试
# -----------------------------------------------------------------------------
pyc_log "运行 Cube v2 测试..."
if [[ -n "${PYC_TRACE:-}" ]]; then
  pyc_log "跟踪已启用 (PYC_TRACE=${PYC_TRACE})"
fi
if [[ -n "${PYC_VCD:-}" ]]; then
  pyc_log "VCD 输出已启用 (PYC_VCD=${PYC_VCD})"
fi

"${WORK_DIR}/tb_cube"

pyc_log "测试完成"
